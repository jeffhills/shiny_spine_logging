---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(shiny)
library(sf)
library(tidyverse)
library(ggplot2)
library(shinyWidgets)
library(shinyBS)
library(colourpicker)
library(kableExtra)
library(cowplot)
library(ggpubr)
library(magick)
library(ggpattern)
library(glue)
library(rlist)
library(janitor)

# install.packages("htmlwidgets")
# library(htmlwidgets)

# source("functions.R", local = TRUE)
# source("labels_screws_functions.R", local = TRUE)

# source("load_coordinates.R", local = TRUE)
source("hook_function.R", local = TRUE)
source("screw_function.R", local = TRUE)
source("osteotomies_decompressions_functions.R", local = TRUE)
source("load_coordinates.R", local = TRUE)

spine_png <- image_read(path = "posterior_spine_figure.png")
# source("implant_sizes_functions.R", local = TRUE)
# remotes::install_github("coolbutuseless/ggpattern")


reference_points_wide_df <- implant_starts_df %>%
  arrange(vertebral_number) %>%
  select(level, vertebral_number, contains("_x"), contains("_y")) %>%
  select(-left_x, -right_x, -superior_y, -inferior_y) %>%
  filter(!is.na(body_center_y)) %>%
    distinct() 


fusion_levels_df <- all_implants_constructed_df   %>%
  filter(category == "implant") %>%
  filter(str_detect(object, "screw")) %>%
  filter(vertebral_number < 26) %>%
  arrange(vertebral_number) %>%
  select(level, vertebral_number) %>%
  distinct()


interbody_levels_df <- all_implants_constructed_df %>%
  filter(str_detect(level, "-")) %>%
  select(level, vertebral_number) %>%
  distinct() %>%
  add_row(level = "O-C1", vertebral_number = 0.5) %>%
  arrange(vertebral_number)

fusion_levels_confirmed_df <- expand_grid(level = fusion_levels_df$vertebral_number, to_check =  fusion_levels_df$vertebral_number) %>%
  filter(to_check != level) %>%
  filter(level == to_check - 1) %>%
  mutate(vertebral_number = (level + to_check)/2) %>%
  rename(primary_level = level) %>%
  select(vertebral_number)

fusion_levels_confirmed_df

test <- fusion_levels_confirmed_df %>%
  filter(vertebral_number <12 | vertebral_number > 19)

construct_spanned_df <- tibble(vertebral_number = seq(from = min(test$vertebral_number), to = max(test$vertebral_number), by = 1))

if(nrow(test) > nrow(construct_spanned_df)*0.6){
  fusion_levels_estimated <- construct_spanned_df
}else{
  fusion_levels_estimated <- test
}

fusion_levels_estimated

construct_spanned_df

interbody_levels_df %>%
  union_all(test)

test <- NULL


test_surgery_df <- all_implants_constructed_df %>%
  filter(level == "L4" | level == "L5") %>%
  filter(object == "pedicle_screw" | object == "central_laminectomy")

test_surgery_df
fusion_test_df <- levels_numbered_df %>%
  filter(level == "L4-L5")

full_posterior_op_note_generator_function(all_objects_to_add_df = test_surgery_df, 
                                          fusion_levels_df = fusion_test_df,
                                          left_main_rod_size = "5.5", 
                                          left_main_rod_material = "titanium",
                                          right_main_rod_size = "5.5mm", 
                                          right_main_rod_material = "titanium", 
                                          antibiotics = c("Ancef", "Vancomycin"),
                                          deep_drains = 2, superficial_drains = 1, 
                                          closure = c("Nylon", "Dermabond"), 
                                          additional_procedural_details = c("Spinal Cord Monitoring"), 
                                          end_procedure_details = "Vancomycin Powder", 
                                          open_canal_vector = c(""))

```

```{r}

test_laminoplasty <- all_implants_constructed_df %>%
  filter(object == "laminoplasty")

max(test_laminoplasty$superior_y)

laminoplasty_cut_df <- tibble(x = 0.515, y =  c(max(test_laminoplasty$superior_lamina_y), min(test_laminoplasty$inf)))


laminoplasty_cut_df <- st_linestring(rbind(c(0.52, max(test_laminoplasty$superior_y)), c(0.52, min(test_laminoplasty$superior_y))))



laminoplasty_sf <- st_multipolygon((all_implants_constructed_df %>% filter(object == "laminoplasty"))$object_constructed)


laminoplasty_sf[[1]](2)

ggdraw() +
  draw_image(
    spine_png,
    scale = 1,
    y = 0,
    valign = 0,
    x = 0,
    width = 1
  ) + 
  geom_sf(data = laminoplasty_sf, fill  = "blue") + 
  geom_line(data = laminoplasty_cut_df, aes(x = x, y = y), linetype = "dotted", size = 2, color = "red") + 
  xlim(0.3, 0.7)


if(any(all_implants_constructed_df$object == "laminoplasty")){
  print("true")
  }

```



```{r}
implant_starts_df <- read_csv(file = "full_coordinates_df.csv") %>%
  filter(!is.na(x))

left_label_x <- 0.32
right_label_x <- 1 - left_label_x

labels_df <- implant_starts_df %>%
  select(level, vertebral_number, body_center_y) %>%
  filter(!is.na(vertebral_number)) %>%
  filter(str_detect(string = level, pattern = "-", negate = TRUE)) %>%
  distinct()%>%
  mutate(y = body_center_y + 0.01)

all_implants_constructed_main_rod_df <- implant_starts_df %>%
  filter(category == "implant") %>%
  filter(implant != "kyphoplasty") %>%
  mutate(rod = "main_rod") %>%
  mutate(sublaminar_band_length = length) %>%
  mutate(length_for_tether = length) %>%
  mutate(object_constructed = pmap(.l =  list(..1 = implant, 
                                              ..2 = x, 
                                              ..3 = y, 
                                              ..4 = angle,
                                              ..5 = length, 
                                              ..6 = width,
                                              ..7 = rod, 
                                              ..8 = sublaminar_band_length,
                                              ..9 = length_for_tether), .f = ~ screw_hook_implant_function(implant_type = ..1, 
                                                                                                           main_or_sattelite_rod = ..7, 
                                                                                                           start_x = ..2,
                                                                                                           y = ..3,
                                                                                                           angle = ..4,
                                                                                                           screw_length_mod = ..5,
                                                                                                           screw_width_mod = ..6, 
                                                                                                           sublaminar_band_length = ..8, 
                                                                                                           length_for_tether = ..9)))

implant_starts_df %>%
  filter(category == "implant") %>%
  filter(implant == "kyphoplasty") %>%
  mutate(rod = "main_rod") %>%
  mutate(sublaminar_band_length = length) %>%
  mutate(length_for_tether = length) %>%
  print()
  mutate(object_constructed = pmap(.l =  list(..1 = implant, 
                                              ..2 = x, 
                                              ..3 = y, 
                                              ..4 = angle,
                                              ..5 = length, 
                                              ..6 = width,
                                              ..7 = rod, 
                                              ..8 = sublaminar_band_length,
                                              ..9 = length_for_tether), .f = ~ screw_hook_implant_function(implant_type = ..1, 
                                                                                                           main_or_sattelite_rod = ..7, 
                                                                                                           start_x = ..2,
                                                                                                           y = ..3,
                                                                                                           angle = ..4,
                                                                                                           screw_length_mod = ..5,
                                                                                                           screw_width_mod = ..6, 
                                                                                                           sublaminar_band_length = ..8, 
                                                                                                           length_for_tether = ..9)))
```


## For adding a new object

```{r}
# osteotomy_factor <- c("grade_1", "complete_facetectomy", "grade_2", "grade_3", "grade_4", "grade_5")

kyphoplasty_df <- implant_starts_df %>%
  filter(implant == "tether") %>%
  mutate(implant = "kyphoplasty") %>%
  mutate(y = body_center_y) %>%
  filter(level != "C1")


updated_implant_starts_df <- implant_starts_df %>%
  union_all(kyphoplasty_df) %>%
  arrange(category, implant, side, vertebral_number) 
  

all_implants_long_wide_df_with_facetectomy_df <- all_implants_long_wide_df %>%
  union_all(facetectomy_df) %>%
  arrange(category, implant, side, vertebral_number) 

# write_csv(x = updated_implant_starts_df, file = "full_coordinates_df.csv", na = "")
# 
```


```{r}
input_right_main_rod_material <- "titanium"
input_date_of_birth = "1900-01-05"
input_right_main_rod_size <- "5.5mm"
input_left_main_rod_material <- "titanium"
input_left_main_rod_size <- "5.5mm"
input_allograft <- 0
input_bmp_size <- 8.4
input_bmp_number <- 3
input_txa_maintenance <- 5
input_txa_loading <- 30
input_anti_fibrinolytic <- "Tranexamic Acid (TXA)"
input_preop_antibiotics <- c("Ancef", "Vanc")
input_relevant_history <- ""
input_bone_density <- "200"
input_symptoms <- c("neck pain", "arm pain")
input_date_of_surgery <- "3-3-2021"
input_patient_name <- "Bob"

patient_name <- if_else(input_patient_name == "", "--", input_patient_name)
age <- if_else(paste(input_date_of_birth) == "1900-01-01", "--", as.character(round(interval(start = paste(input_date_of_birth), end = paste(input_date_of_surgery))/years(1), 0)))
patient_name_age <- case_when(
  patient_name == "--" ~ "--",
  patient_name != "--" & age == "--" ~ patient_name,
  patient_name != "--" & is.na(age) ~ patient_name,
  patient_name != "--" & age != "--" ~ paste(patient_name, ", ", age, "yrs", sep = ""),
)
symptoms <- if_else(length(input_symptoms) == 0, "--", toString(input_symptoms))
bone_density <- if_else(input_bone_density == "", "--", input_bone_density)
relevant_history <- if_else(input_relevant_history == "", "--", input_relevant_history)
preop_antibiotics <- if_else(length(input_preop_antibiotics) == 0, "--", toString(input_preop_antibiotics))
anti_fibrinolytic <- case_when(
  length(input_anti_fibrinolytic) == 0 ~ "--",
  length(input_anti_fibrinolytic) == 1 & "Tranexamic Acid (TXA)" %in% input_anti_fibrinolytic ~ paste(glue("TXA (Load: {input_txa_loading}, Maint: {input_txa_maintenance})")),
  length(input_anti_fibrinolytic) > 1 & "Tranexamic Acid (TXA)" %in% input_anti_fibrinolytic ~ paste(glue("{toString(setdiff(x = input_anti_fibrinolytic,
                                                                                                                       y = 'Tranexamic Acid (TXA)'))}, 
                                                                                                                       TXA (Loading: {input_txa_loading}, Maint: {input_txa_maintenance})")),
  length(input_anti_fibrinolytic) > 0 & ("Tranexamic Acid (TXA)" %in% input_anti_fibrinolytic) == FALSE ~ toString(input_anti_fibrinolytic)
)

bmp_text <- if_else(input_bmp_number == 0, "None", paste(input_bmp_number, input_bmp_size, sep = " "))
bmp_mg_dose <- as.double(input_bmp_size)*as.double(input_bmp_number)
bmp <- if_else(bmp_text == "None", "None", paste(bmp_text, "(", as.character(bmp_mg_dose), "mg)"))

allograft <- if_else(input_allograft == 0, "None", paste(input_allograft, "cc", sep = ""))
left_rod <- paste(input_left_main_rod_size, input_left_main_rod_material, sep = " ")
right_rod <- paste(input_right_main_rod_size, input_right_main_rod_material, sep = " ")


        # 
plan_df <- tibble(descriptor = c("Patient:", "Symptoms:", "Bone Density:", "Relevant Hx:", "---", "Preop Abx:", "Antifibrinolytic:", "Allograft", "BMP:", "Left Rod:", "Right Rod:"), 
               value = c(patient_name_age, symptoms, bone_density, relevant_history, "---", preop_antibiotics, anti_fibrinolytic, bmp, allograft, left_rod, right_rod)
        ) %>% 
            filter(!is.null(value)) %>%
            filter(value != "--")
plan_df


plot_top_y <- 0.84

y_spacing <- 0.03

y_start_with_text <- plot_top_y + nrow(plan_df)*y_spacing



plan_with_y <- plan_df %>%
  mutate(y = seq(from = y_start_with_text - y_spacing, to = plot_top_y, by = -y_spacing))
plan_with_y

implant <- st_buffer(x = st_point(x = c(0.5, 0.7)), dist = 0.01)

open_levels <- c("L2")

open_canal_test <- open_canal_df %>%
  filter(level %in% open_levels)

canal_sf <- st_union(st_combine(st_multipolygon(open_canal_test$object_constructed)), by_feature = TRUE, is_coverage = TRUE)

open_combined_sf <- st_combine(st_multipolygon(open_canal_test$object_constructed))

open_united_sf <- st_union(open_combined_sf, by_feature = TRUE, is_coverage = TRUE)

# st_union(st_combine(), by_feature = TRUE, is_coverage = TRUE)

ggdraw() +
  draw_image(
    spine_png,
    scale = 1,
    y = 0,
    valign = 0,
    x = 0,
    width = 1
  ) + 
  geom_sf_pattern(data = canal_sf, pattern = "plasma", pattern_alpha = 0.5, alpha = 0.3, color = "grey96") +
  # draw_text(text = plan_with_y$descriptor, x = 0.4, y = plan_with_y$y) +
  ylim(0,0.4) + 
  xlim(0,1)

implant_starts_df %>%
  filter(implant == "laminectomy") %>%
  mutate(category = "revision") %>%
  mutate(implant = "open_canal")

implant_starts_df %>%
  filter(str_detect(string = implant, pattern = "hook"))

test <- implant_starts_df %>%
  filter(level %in% c("L1", "L2", "L3", "L4", "L5")) %>%
  filter(category == "osteotomy") %>%
  mutate(keep = case_when(
    level == "L1" & implant == "complete_facetectomy" ~ "keep",
    level == "L2" & implant == "complete_facetectomy" & side == "left" ~ "keep",
    level == "L2" & implant == "grade_1" & side == "right" ~ "keep",
    level == "L4" ~ "keep"
  )) %>%
  select(level, keep, everything()) %>%
  filter(keep == "keep") %>%
  mutate(implant = fct_relevel(as_factor(implant), c("grade_1", "complete_facetectomy", "grade_2", "grade_3", "grade_4", "grade_5"))) %>%
  arrange(implant) %>%
  mutate(implant_rank = as.numeric(implant)) %>%
  select(level, implant_rank, everything()) %>%
  arrange(level, implant_rank) %>%
  mutate(side_value = case_when(
    side == "central" ~ 3,
    side == "left" ~1,
    side == "right" ~ 1
  )) %>%
  group_by(level, side) %>%
  filter(implant_rank == max(implant_rank)) %>%
  group_by(level) %>%
  filter(side_value == max(side_value)) %>%
  select(-implant_rank, -side_value)

implant_starts_df %>%
  select(level, vertebral_number) %>%
  distinct() %>%
  arrange(vertebral_number)

test_full <- implant_starts_df %>%
  filter(vertebral_number %in% c(10,11,12,13,14,15,16, 17)) %>%
  filter(implant == "pedicle_screw") %>%
  filter(side == "left")

test_accessory <- implant_starts_df %>%
  filter(vertebral_number %in% c(13,14,15)) %>%
  filter(implant == "pedicle_screw") %>%
  filter(side == "left")

test_accessory
test_sf <- build_additional_rod_function(rod_type = "accessory", new_rod_vector = test_accessory$level, full_implant_vector = test_full)


        supplemental_rods_df <- tibble(supplemental_rod = c("accessory_rod", 
                                    "satellite_rod", 
                                    "intercalary_rod",
                                    "linked_rods",
                                    "accessory_rod", 
                                    "satellite_rod", 
                                    "intercalary_rod",
                                    "linked_rods"), 
                                    side = c("left", "left", "left", "left", "right", "right", "right", "right"),
               yes_no = c(TRUE,
                          FALSE,
                          TRUE,
                          FALSE,
                          FALSE,
                          FALSE,
                          FALSE,
                          FALSE)) %>%
            filter(yes_no == TRUE)
        
        left_supplemental_rods_df <- if_else(nrow(supplemental_rods_df %>% filter(side == "left")) == 0, "none", toString((supplemental_rods_df %>% filter(side == "left"))$supplemental_rod))

        
    implant_starts_df    
    test_full <- implant_starts_df %>%
      filter(between(vertebral_number, 10, 14)) %>%
      filter(category == "decompression")
    
   testt <- tibble(first = "a", second = "b", third = "x") 
     
   testt %>%
   as.matrix() %>%
     t() %>%
     as_tibble(rownames = "variable") %>%
     rename(result = "V1")
      
     
        
```


```{r}
        rcon <- redcapConnection(url = 'https://redcap.wustl.edu/redcap/api/', token = "4B2AA28A4D6EFBC6CA1F49EC0FB385F7")

        redcap_exported_df <- exportRecords(rcon = rcon)



        number_of_records <- redcap_exported_df %>%
            select(record_id) %>%
            mutate(record_id = as.double(record_id)) %>%
            filter(record_id == max(record_id)) %>%
            distinct()

        new_record_number <- number_of_records[[1]] +1
        
        new_record_number

        upload_test <- implant_starts_df %>%
            select(level, side, implant) %>%
            filter(implant == "pedicle_screw", level == "l1") %>%
            mutate(level_side = paste(level, side, sep = "_")) %>%
            select(implant, level_side) %>%
            pivot_wider(names_from = level_side, values_from = implant) %>%
            mutate(last_name = "test_name") %>%
            mutate(record_id = new_record_number) %>%
            select(record_id, last_name, everything())
        
        implant_starts_df %>%
          rename_all(.funs = ~paste(., "_shiny", sep = ""))

        
        paste(as.double(8)*as.double(9))
        



```



```{r}


row_numbers_df <- implant_starts_df %>%
    select(level) %>%
    distinct() %>%
    mutate(vertebral_number = row_number())

all_implants_constructed_df <- all_implants_constructed_main_rod_df %>%
    union_all(osteotomy_df) %>%
    union_all(decompression_df) %>%
    select(-vertebral_number) %>%
    left_join(row_numbers_df) %>%
    select(level, vertebral_number, everything())

# l4_pso_df <- all_implants_constructed_df %>%
#   filter(implant == "grade_3") %>%
#   filter(level == "L4")


osteotomy_grades_df <- tibble(implant = c("grade_1", "grade_2", "grade_3", "grade_4", "grade_5"), 
                              osteotomy_order = c(1, 2, 3, 4, 5))

all_implants_constructed_df
all_implants_constructed_df %>%
  filter(category == "osteotomy") %>%
  left_join(osteotomy_grades_df) %>%
  select(level, osteotomy_order, everything()) %>%
  group_by(level) 
  filter(osteotomy_order == max(osteotomy_order))
  

l4_pso_df <- all_implants_constructed_df %>%
  filter(implant == "grade_3") %>%
  filter(level == "L4")
  
```
## using reference points
```{r}

mean(test$y[1], test$y[2]) 

mean(tail(test$y, n = 2))

mean(head(test$y, n = 2))

top <- tibble(x = test$x[1], y = mean(head(test$y, n = 2)))

bottom <- tibble(x =test$x[1],y =  mean(tail(test$y, n = 2)))

top %>%
  bind_rows(bottom)

top %>%
                union_all(test) %>%
                union_all(bottom)

tibble(x = c(tail(test$x, n = 1),
                                             tail(test$x, n = 1) + 0.005),
                                       y = mean(tail(test$y, n = 2))) 

test <- implant_starts_df %>%
  filter(implant == "pedicle_screw", side == "left") %>%
  filter(y > 0.35) %>%
  filter(y < 0.75)

test
```


```{r}

linked_overlap_vector <- c("T8", "T9", "T10", "T11")

"T9" %in% linked_overlap_vector

setdiff(x = linked_overlap_vector, y = "T9")


linked_rods_sf <- build_additional_rod_function(rod_type = "linked", new_rod_vector = linked_overlap_vector, full_implant_vector = test, offset_medial = 0.006)

implant_starts_df %>%
  names()
new_rod_vector <- linked_overlap_vector
full_implant_vector <- test
offset_value <- 0.006
```

```{r}
    overlap_df <- tibble(level = new_rod_vector) %>%
      left_join(full_implant_vector) %>%
      select(x, y) %>%
      arrange(rev(y)) %>%
      distinct()
    
    top_of_distal_rod_y <- max(overlap_df$y)
    bottom_of_proximal_rod_y <- min(overlap_df$y)
    
    overlap_midpoint_y <- mean(overlap_df$y)
    
    overlap_midpoint_y
    
    upper_rod_df <- full_implant_vector %>%
      filter(y >= bottom_of_proximal_rod_y) %>%
      mutate(x = x + offset_value/2) %>%
      select(x, y) 
    
    upper_rod_matrix <- upper_rod_df%>%
      filter(y == min(y)) %>%
      mutate(y = mean(overlap_midpoint_y, min(upper_rod_df$y))) %>%
      union_all(upper_rod_df) %>%
      arrange(rev(y)) %>%
      select(x, y) %>%
      as.matrix() 
    
  upper_rod_df
  mean(tail(upper_rod_df$y, n = 2))
    
    top_connector <- tibble(x = c(overlap_df$x[1] - offset_value/1.5,
                                  overlap_df$x[1] + offset_value/1.5), 
                            y = mean(tail(upper_rod_df$y, n = 2))) %>%
      select(x, y) %>%
      as.matrix()
    
    top_connector
    
    bottom_connector <- tibble(x = c(tail(overlap_df$x, n = 1)- offset_value/1.5,
                                     tail(overlap_df$x, n = 1)+ offset_value/1.5),
                               y = mean(tail(overlap_df$y, n = 2))) %>%
      as.matrix()
    
    lower_rod_df <- full_implant_vector %>%
      filter(y <= top_of_distal_rod_y) %>%
      mutate(x = x - offset_value/2) %>%
      select(x, y) 
    
    lower_rod_matrix <- lower_rod_df%>%
      filter(y == max(y)) %>%
      mutate(y = mean(overlap_midpoint_y, max(upper_rod_df$y))) %>%
      union_all(lower_rod_df) %>%
      arrange(rev(y)) %>%
      select(x, y) %>%
      as.matrix() 
    
mean(overlap_midpoint_y, max(upper_rod_df$y))

abs(diff(tail(upper_rod_df$y, n = 2)))

(test %>%
  filter(between(vertebral_number, median(vertebral_number), median(vertebral_number + 1))))$level


data_wide_df <- implant_starts_df %>% 
  filter(implant == "pedicle_screw" | implant == "sublaminar_decompression" | implant == "foraminotomy") %>%
  filter(y > 0.4) %>%
  filter(y < 0.65) %>%
  arrange(vertebral_number) %>%
  select(level, category, procedure = implant, side) %>%
  pivot_wider(names_from = level, values_from = procedure) %>%
  mutate(across(everything(), ~ replace_na(.x, "")))
  
data_wide_df

map_df(.x = names(data_wide_df), .f = ~ replace_na)

implant_starts_df %>%
  filter(category == "osteotomy") %>%
  tabyl(implant)

any(str_detect(string = implant_starts_df$implant, pattern = "pelvic"))
        three_column_osteotomy <- any(str_detect(string = implant_starts_df$implant, pattern = "grade_d") | str_detect(string = implant_starts_df$implant, pattern = "grade_3")  | str_detect(string = implant_starts_df$implant, pattern = "grade_x"))
        three_column_osteotomy

        linked_overlap_vector
        
toString(linked_overlap_vector)

```



```{r}
# anterior_df <- implant_starts_df %>%
#   filter(str_detect(string = category, pattern = "anterior")) %>%
#   remove_empty()

anterior_implant_function <- function(object_type, body_width, superior_endplate_y, inferior_endplate_y, superior_enplate_inferior_body_y = NULL, inferior_endplate_superior_body_y = NULL){
  left_body_x <- 0.5 - (body_width*0.9)
  right_body_x <- 0.5 + (body_width*0.9)
  left_cage_x <- 0.5 - (body_width*0.5)
  right_cage_x <- 0.5 + (body_width*0.5)
  
  if(object_type == "corpectomy_cage"){
    left_x <- left_cage_x
    right_x <- right_cage_x
    
    bottom_left <- c(left_x, superior_enplate_inferior_body_y)
    bottom_right <- c(right_x, superior_enplate_inferior_body_y)
    top_right <- c(right_x, inferior_endplate_superior_body_y)
    top_left <- c(left_x, inferior_endplate_superior_body_y)
    
    object_sf <- st_buffer(st_polygon(list(rbind(bottom_left,bottom_right,top_right, top_left, bottom_left))), dist = 0.002, endCapStyle = "FLAT")
  }
  
    if(object_type == "anterior_plate" | object_type == "anterior_buttress_plate"){
    left_x <- left_cage_x
    right_x <- right_cage_x
    
    bottom_left <- c(left_x, inferior_endplate_y)
    bottom_right <- c(right_x, inferior_endplate_y)
    top_right <- c(right_x, superior_endplate_y)
    top_left <- c(left_x, superior_endplate_y)
    
    object_sf <- st_buffer(st_polygon(list(rbind(bottom_left,bottom_right,top_right, top_left, bottom_left))), dist = 0.0015, endCapStyle = "ROUND")
    }
  
    if(object_type == "corpectomy"){
    left_x <- left_body_x
    right_x <- right_body_x
    
    bottom_left <- c(left_x, inferior_endplate_y)
    bottom_right <- c(right_x, inferior_endplate_y)
    top_right <- c(right_x, superior_endplate_y)
    top_left <- c(left_x, superior_endplate_y)
    
    object_sf <- st_buffer(st_polygon(list(rbind(bottom_left,bottom_right,top_right, top_left, bottom_left))), dist = 0.0015, endCapStyle = "ROUND")
  }
  
    if(object_type == "diskectomy_fusion"){
    left_x <- left_body_x
    right_x <- right_body_x
    
    bottom_left <- c(left_x, inferior_endplate_y)
    bottom_right <- c(right_x, inferior_endplate_y)
    top_right <- c(right_x, superior_endplate_y)
    top_left <- c(left_x, superior_endplate_y)
    
    bottom_left_interbody <- c(left_cage_x, inferior_endplate_y)
    bottom_right_interbody  <- c(right_cage_x, inferior_endplate_y)
    top_right_interbody  <- c(right_cage_x, superior_endplate_y)
    top_left_interbody  <- c(left_cage_x, superior_endplate_y)
    
    object_sf <- st_buffer(st_polygon(list(rbind(bottom_left,bottom_right,top_right, top_left, bottom_left))), dist = 0.002, endCapStyle = "ROUND")

    }
  
    if(object_type == "diskectomy_fusion_no_interbody_device"){
    left_x <- left_body_x
    right_x <- right_body_x
    
    bottom_left <- c(left_x, inferior_endplate_y)
    bottom_right <- c(right_x, inferior_endplate_y)
    top_right <- c(right_x, superior_endplate_y)
    top_left <- c(left_x, superior_endplate_y)
    
    object_sf <- st_buffer(st_polygon(list(rbind(bottom_left,bottom_right,top_right, top_left, bottom_left))), dist = 0.0015, endCapStyle = "FLAT")
    }
  
  if(object_type == "screw_washer"){
    object_sf <- st_buffer(st_point(c(0.5, inferior_endplate_y)),dist = 0.01, endCapStyle = "ROUND")
  }

  
  return(object_sf)
}

anterior_df <- implant_starts_df %>%
  filter(str_detect(string = category, pattern = "anterior")) %>%
  remove_empty() 

anterior_objects_df <- anterior_df %>%
  # filter(implant == "diskectomy_fusion ") %>%
  mutate(object_constructed = pmap(list(..1 = implant,
                                        ..2 = width,
                                        ..3 = inferior_endplate_y,
                                        ..4 = superior_endplate_y, 
                                        ..5 = superior_enplate_inferior_body_y, 
                                        ..6 = inferior_endplate_superior_body_y),
                                   .f = ~ anterior_implant_function(object_type = ..1, 
                                                                    body_width = ..2,
                                                                    inferior_endplate_y = ..3,
                                                                    superior_endplate_y = ..4,
                                                                    superior_enplate_inferior_body_y = ..5, 
                                                                    inferior_endplate_superior_body_y = ..6)))

test_df <- anterior_objects_df %>%
  # filter(vertebral_number > 22) %>%
  filter(implant == "screw_washer")

labels_anterior_df <- anterior_objects_df %>%
  select(level, x, y) %>%
  filter(str_detect(string = level, pattern = "-") == FALSE) %>%
  distinct()

labels_anterior_df

lines_df <- tibble(major = seq(from = 0.1, to = 1, by = 0.05))
lines_small_df <- tibble(minor = seq(from = 0.1, to = 1, by = 0.01))


ggdraw() +
    # draw_text(text = lines_df$major, x = 0.35, y = lines_df$major, size = 7) +
  # geom_hline(yintercept = lines_df$major) + 
  draw_image(
    anterior_spine_jpg,
    scale = 1,
    y = 0,
    valign = 0,
    x = 0,
    width = 1
  ) + 
  # geom_hline(yintercept = lines_small_df$minor, color = "red", size = 0.01, alpha = 0.5) + 
  draw_text(text = labels_anterior_df$level, x = 0.65, y = labels_anterior_df$y) +
  # geom_vline(xintercept = c(0.45,0.46,0.47,0.48,0.49)) +
  # geom_hline(yintercept = c(seq(from = 0.1, to = 1, by = 0.01)), size = .4, color = "blue") +
  # geom_hline(yintercept = c(seq(from = 0.1, to = 1, by = 0.05)), size = 1, color = "black") +
  geom_sf(data = st_multipolygon(test_df$object_constructed)) +
  ylim(0,1) + 
  xlim(0,1)



anterior_objects_df


```
```{r}
        if(any(str_detect(string = anterior_objects_df$implant, pattern = "anterior_buttress_plate"))){
            anterior_buttress_plate_sf <- st_multipolygon((anterior_objects_df %>% filter(implant == "anterior_buttress_plate"))$object_constructed)
        }else{
            anterior_buttress_plate_sf <- NULL
        }
        
        if(any(str_detect(string = anterior_objects_df$implant, pattern = "anterior_plate"))){
            anterior_plate_sf <- st_union(st_combine(st_multipolygon((anterior_objects_df %>% filter(implant == "anterior_plate"))$object_constructed)), by_feature = TRUE, is_coverage = TRUE)
        }else{
            anterior_plate_sf <- NULL
        }
        
        if(any(str_detect(string = anterior_objects_df$implant, pattern = "corpectomy"))){
            corpectomy_sf <- st_union(st_combine(st_multipolygon((anterior_objects_df %>% filter(implant == "corpectomy"))$object_constructed)), by_feature = TRUE, is_coverage = TRUE)
        }else{
            corpectomy_sf <- NULL
        }
        
        if(any(str_detect(anterior_objects_df$implant, pattern = "corpectomy_cage"))){
            corpectomy_cage_sf <- st_union(st_combine(st_multipolygon((anterior_objects_df %>% filter(implant == "corpectomy_cage"))$object_constructed)), by_feature = TRUE, is_coverage = TRUE)
            
        }else{
            corpectomy_cage_sf <- NULL
        }
        
        if(any(str_detect(string = anterior_objects_df$implant, pattern = "diskectomy_fusion"))){
            diskectomy_fusion_sf <- st_multipolygon((anterior_objects_df %>% filter(implant == "diskectomy_fusion"))$object_constructed)
        }else{
            diskectomy_fusion_sf <- NULL
        }
        
        if(any(str_detect(string = anterior_objects_df$implant, pattern = "diskectomy_fusion_no_interbody_device"))){
            diskectomy_fusion_no_interbody_device_sf <- st_multipolygon((anterior_objects_df %>% filter(implant == "diskectomy_fusion_no_interbody_device"))$object_constructed)
        }else{
            diskectomy_fusion_no_interbody_device_sf <- NULL
        }
        
        if(any(str_detect(string = anterior_objects_df$implant, pattern = "screw_washer"))){
            screw_washer_sf <- st_multipolygon((anterior_objects_df %>% filter(implant == "screw_washer"))$object_constructed)
        }else{
            screw_washer_sf <- NULL
        }

test <- c("a", "b", "c")


any(test == "c")

all_implants_constructed_df %>%
  filter(implant == "pedicle_hook")

pedicle_hook

all_implants_constructed_df %>%
            as_tibble() %>%
            select(-object_constructed) %>%
            arrange(vertebral_number) %>%
            select(level, approach, category, procedure = implant, side) %>%
  # filter(approach == "posterior") %>%
  group_by(level, side) %>%
  mutate(count = row_number()) %>%
            pivot_wider(names_from = c(level, side), values_from = procedure) %>%
            mutate(across(everything(), ~ replace_na(.x, ""))) 

```

```{r}

test_textbox_df <- tibble(variable = c("name", "procedure", "levels"), result = c("test name", "spinal fusion", "L1, L2, L3, L4, L5, L1, L2, L3, L4, L5, L1, L2, L3"))

test_textbox_with_xy_df <- test_textbox_df %>%
  mutate(x = 0.5, x_label = 0.4, y = seq(from = 1, to = 1.05-nrow(test_textbox_df)*0.05, by = -0.05))




ggdraw() +
                draw_image(
                    spine_png,
                    scale = 1,
                    y = 0,
                    valign = 0,
                    x = 0,
                    height = 1
                ) 





  ggtext::geom_textbox(data = test_textbox_with_xy_df, aes(label = paste(variable, result),  x = x, y = y), size = 8/2.85)+
  xlim(0.2, 0.8) + 
  ylim(0,1)

test_textbox_with_xy_df


all_implants_constructed_df %>%
  filter(category == "decompression") %>%
  tabyl(object)

implant_starts_df %>%
  filter(category == "decompression") %>%
  tabyl(object)

implant_starts_df %>%
  filter(approach == "posterior") %>%
  filter(category == "decompression") %>%
  mutate(object_constructed = pmap(list(..1 = left_x,
                                        ..2 = superior_y,
                                        ..3 = right_x,
                                        ..4 = inferior_y,
                                        ..5 = width, 
                                        ..6 = object,
                                        ..7 = lateral_pars_x,
                                        ..8 = superior_tp_y,
                                        ..9 = side, 
                                        ..10 = inferior_pedicle_y), 
                                   .f = ~ build_decompression_function(left_x = ..1, right_x = ..3, superior_y = ..2, inferior_y = ..4, top_width = ..5, object = ..6, x_lateral_pars = ..7, y_inferior_tp = ..8, side = ..9, inferior_pedicle_y = ..10)))

```

```{r}

all_implants_constructed_df

data_wide <- all_implants_constructed_df %>%
  as_tibble() %>%
  select(-object_constructed) %>%
  arrange(vertebral_number) %>%
  select(level, approach, category, procedure = implant, side) 
  
data_wide %>%
group_by(level, side, category) %>%
  mutate(redcap_repeat_instance = row_number()) %>%
  pivot_wider(names_from = level, values_from = procedure)
  mutate(across(everything(), ~ replace_na(.x, ""))) %>%
  # mutate(record_id = new_record_number) %>%
  ungroup() %>%
  mutate(redcap_repeat_instance = row_number()) %>%
  mutate(redcap_repeat_instrument = "surgical_construct_repeating") %>%
  select(redcap_repeat_instrument, redcap_repeat_instance, everything()) %>%
  clean_names()

data_wide
```
```{r}
            implants_wide_df <- all_implants_constructed_df %>%
  filter(implant == "pedicle_screw") %>%
                mutate(level_side = paste(level, side, implant, sep = "_")) %>%
                select(level, level_side, side) %>%
                pivot_wider(names_from = side, values_from = level_side)

all_implants_constructed_df %>%
  filter(implant == "pedicle_screw") %>%
                mutate(level_side = paste(level, side, implant, sep = "_")) %>%
                select(level, level_side, side) %>%
  pivot_wider(names_from = side, values_from = level_side)

            implants_wide_df
            
            
            df_names <- glue_collapse(names(implants_wide_df), sep = " ")

            
            
            level_vector <- implants_wide_df$level
            
```




```{r}

# ggdraw() +
#   draw_image(
#     anterior_spine_jpg,
#     scale = 1,
#     y = 0,
#     valign = 0,
#     x = 0,
#     height = 1) +
#   geom_sf_pattern(data = withpatterns_df, aes(geometry = object_constructed, pattern = implant_pattern, pattern_fill = pattern_color))
#                   ggpattern::geom_sf_pattern(
#                     data =  anterior_plate_sf, 
#                     pattern = "plasma", 
#                     pattern_colour = "grey60") 
#                 ggpattern::geom_sf_pattern(
#                     data =  screw_washer_sf, 
#                     pattern = "gradient",  
#                     pattern_orientation = "radial",
#                     fill = "grey70", 
#                     pattern_fill2 = NA,
#                     colour = NA) +
# ylim(0,1) + 
#   xlim(0.2, 0.8)

# spine_plot
# 
# withpatterns_df <- anterior_objects_df %>%
#   mutate(implant_pattern = case_when(
#     implant == "anterior_buttress_plate" ~ "gradient",
#     implant == "anterior_plate" ~ "gradient",
#     implant == "corpectomy" ~ "stripe",
#     implant == "corpectomy_cage" ~ "gradient",
#     implant == "diskectomy_fusion" ~ "stripe",
#     implant == "diskectomy_fusion_no_interbody_device" ~ "circle",
#     implant == "screw_washer" ~ "gradient",
#   )) %>%
#   mutate(pattern_color = case_when(
#     implant == "anterior_buttress_plate" ~ "grey50",
#     implant == "anterior_plate" ~ "grey50",
#     implant == "corpectomy" ~ "red",
#     implant == "corpectomy_cage" ~ "grey80",
#     implant == "diskectomy_fusion" ~ "red",
#     implant == "diskectomy_fusion_no_interbody_device" ~ "#EBAAAA",
#     implant == "screw_washer" ~ "#0056B8",
#   )) 


  tabyl(implant)
```











```{r}
new_rod_vector <- linked_overlap_vector

full_implant_vector <- linked_rod_df

            overlap_df <- tibble(level = new_rod_vector) %>%
                left_join(full_implant_vector) %>%
                select(x, y) %>%
                arrange(rev(y)) %>%
                distinct()
            
            top_of_distal_rod_y <- max(overlap_df$y)
            bottom_of_proximal_rod_y <- min(overlap_df$y)
            
            upper_rod_matrix <- full_implant_vector %>%
                filter(y >= bottom_of_proximal_rod_y) %>%
                mutate(x = x + 0.006/2) %>%
              select(x, y) %>%
                as.matrix() 
          
            top_connector <- tibble(x = c(overlap_df$x[1] - offset_value/2,
                                          overlap_df$x[1] + offset_value/2), 
                                    y = mean(head(overlap_df$y, n = 2))) %>%
               select(x, y) %>%
                as.matrix()
            
            bottom_connector <- tibble(x = c(tail(overlap_df$x, n = 1)- offset_value/2,
                                             tail(overlap_df$x, n = 1)- offset_value/2),
                                       y = mean(tail(overlap_df$y, n = 2))) %>%
                as.matrix()
            
            lower_rod_matrix <- full_implant_vector %>%
                filter(y <= top_of_distal_rod_y) %>%
                mutate(x = x - offset_value/2) %>%
              select(x, y) %>%
                as.matrix() 
                
            upper_rod <- st_buffer(st_linestring(upper_rod_matrix), dist = 0.003, endCapStyle = "ROUND")
            lower_rod <- st_buffer(st_linestring(lower_rod_matrix), dist = 0.003, endCapStyle = "ROUND")
            top_connector <- st_buffer(st_linestring(top_connector), dist = 0.003, endCapStyle = "ROUND")
            bottom_connector <- st_buffer(st_linestring(bottom_connector), dist = 0.003, endCapStyle = "ROUND")
            
            additional_rod_sf <- st_multipolygon(list(upper_rod, lower_rod, top_connector, bottom_connector))
```


## Osteotomies
```{r}

all_implants_constructed_df %>%
  filter(category == "osteotomy") %>%
  mutate(implant = fct_relevel(as_factor(implant), c("grade_1", "complete_facetectomy", "grade_2", "grade_3", "grade_4", "grade_5"))) %>%
  arrange(implant) %>%
  mutate(implant_rank = as.numeric(implant)) %>%
  select(level, implant_rank, everything())  %>% 
  filter(implant_rank < 3) %>%
  group_by(level) %>%
  filter(implant_rank == max(implant_rank)) 


osteotomy_1_df <- all_implants_constructed_df %>%
  filter(implant == "Grade 1")

osteotomy_complete_facetectomy_df <- all_implants_constructed_df %>%
  filter(implant == "complete_facetectomy")

osteotomy_2_df <- all_implants_constructed_df %>%
  filter(grade == "Grade 2")

osteotomy_3_df <- all_implants_constructed_df %>%
  filter(grade == "Grade 3")

osteotomy_3_df

osteotomy_1_sf <- st_geometrycollection(osteotomy_1_df$object_constructed)

osteotomy_2_sf <- st_geometrycollection(osteotomy_2_df$object_constructed)

osteotomy_3_sf <- st_geometrycollection(osteotomy_3_df$object_constructed)

all_implants_constructed_df
```

#Implants
```{r}

screws_df <- all_implants_constructed_df %>%
  filter(str_detect(string = implant, pattern = "screw"))

screws_df

screws_sf <- st_multipolygon(screws_df$object_constructed)

hooks_df <- all_implants_constructed_df %>%
  filter(str_detect(string = implant, pattern = "hook"))

hooks_sf <- st_multipolygon(hooks_df$object_constructed)

wires_df <- all_implants_constructed_df %>%
  filter(str_detect(string = implant, pattern = "wire"))

sublaminar_wires_sf <- st_geometrycollection(wires_df$object_constructed)

sublaminar_wires_sf[1]

wires_df$object_constructed[1]

screws_df %>%
  select(object_constructed)

screws_dfx <- screws_df %>%
  filter(level == "d")


tether_df <- all_implants_constructed_df %>%
  filter(str_detect(string = implant, pattern = "tether"))

tether_sf <- st_geometrycollection(tether_df$object_constructed)


tether_sf <- st_geometrycollection(tether_df$object_constructed)

```

## decompressions
```{r}

decompression_df <- implant_starts_df %>%
    filter(category == "decompression") %>%
    filter(!is.na(width)) %>%
  # filter(level == "L4-L5" | level == "L5-S1") %>%
    mutate(object_constructed = pmap(list(..1 = lateral_x,
                                          ..2 = superior_y,
                                          ..3 = medial_x,
                                          ..4 = inferior_y,
                                          ..5 = width), .f = ~ build_decompression_function(left_x = ..1, right_x = ..3, superior_y = ..2, inferior_y = ..4, top_width = ..5)))


decompression_df
decompressions_laminectomy_df <- decompression_df %>%
  filter(implant == "laminectomy") 

decompressions_sublaminar_df <- decompression_df %>%
  filter(implant == "sublaminar_decompression") 

laminectomy_sf <- st_multipolygon(decompressions_laminectomy_df$object_constructed)

sublaminar_decompression_sf <- st_multipolygon(decompressions_sublaminar_df$object_constructed)

decompressions_sublaminar_df

```

```{r}
pso_df <- all_implants_constructed_df %>%
  filter(level == "L4" | level == "L3") %>%
  filter(category != "implant") %>%
  filter(implant %in% c("grade_3", "laminectomy", "grade_2")) %>%
  select(level, implant, object_constructed) %>%
  filter(level == "L3" & implant == "laminectomy" | level == "L4")


pso2_df <- all_implants_constructed_df %>%
  filter(level == "L2" | level == "L3") %>%
  filter(category != "implant") %>%
  filter(implant %in% c("grade_3", "laminectomy", "grade_2")) %>%
  select(level, implant, object_constructed) %>%
  filter(level == "L2" & implant == "laminectomy" | level == "L3")

# pso_df %>%
#   arrange(level) %>%
#   mutate(count = row_number()) %>%
#   mutate(count_added = count + 1) %>%
#   filter(count >1) %>%
#   mutate(count = count_added) %>%
  

l4_pso_sf_multipol <- st_multipolygon(x = l4_pso_df$object_constructed)

l2_pso_sf_multipol <- st_multipolygon(x = pso2_df$object_constructed)

l4_pso_sf_multipol <- st_simplify(l4_pso_sf_multipol)

l2_pso_sf_multipol <- st_simplify(l2_pso_sf_multipol)

psos_sf <- l2_pso_sf_multipol <- st_multipolygon(x = list(l4_pso_sf_multipol, l2_pso_sf_multipol))

psos_sf
```


```{r, fig.height=8, fig.width=5}

name <- "Bob smith"
dob = "1900-01-05"
plan <- "this is the surgical plan long form for testing reseasons."

test_plan <- tibble(variable = c("name", "dob", "plan"), result = c(name, dob, plan)) 
  # mutate(result_wide = paste("              ", result))


test_plan

results <- glue_collapse(test_plan$result, sep = "<br>")

results <- paste(name, "<br>", dob, "<br>", plan)


df_test <- tibble(x = 0.5, y = 0.9, tb = list(test_plan))


ggdraw() +
  draw_image(
    spine_png,
    scale = 1,
    y = 0,
    valign = 0,
    x = 0,
    width = 1
  ) +
  # ggtext::geom_textbox(aes(label = results, x = 0.5, y = 0.5, hjust = 0.5),label.padding = unit(c(0.2, 0.2, 0.2, 5), units = "lines")) + 
  ylim(0,1) +
  xlim(0,1) + 
  ggpmisc::geom_table(data = df_test, aes(label = tb, x = x, y = y), table.colnames = FALSE)

test_plan %>%
  print()

glue_collapse(x = rep(x = "d", 5), sep = "")

descriptor <-  c("Patient:", "Symptoms:", "Bone Density:", "Relevant Hx:", "---", "Preop Abx:", "Antifibrinolytic:", "Allograft", "BMP:", "Left Rod:", "Right Rod:")

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
