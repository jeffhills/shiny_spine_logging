---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(shiny)
library(shinyWidgets)
library(sf)
library(tidyverse)
library(ggplot2)
library(shinyBS)
library(cowplot)
library(magick)
library(ggpattern)
library(glue)
library(rlist)
library(janitor)
library(lubridate)
library(redcapAPI)
# library(ggpmisc)
# library(rclipboard)
library(nngeo)# 
library(shinydashboard)
source("short_shiny_functions.R", local = TRUE)
source("make_geoms_functions.R", local = TRUE)
source("build_spine_objects_functions.R", local = TRUE)
source("load_coordinates_build_objects.R", local = TRUE)
source("anterior_posterior_operative_note_generator_functions.R", local = TRUE)
source("load_coordinates_build_objects_6_lumbar.R", local = TRUE)
# source("no_implants_added_op_note.R", local = TRUE)
# source("screw_size_type_inputs.R", local = TRUE)

l6_all_implants_constructed_df
```


```{r}

all_screws_long_df <- all_implants_constructed_df %>%
  filter(vertebral_number < 23.9) %>%
  union_all(l6_all_implants_constructed_df) %>%
  select(level, vertebral_number, side, object) %>%
  filter(str_detect(object, "screw")) %>%
  filter(side == "left" | side == "right") %>%
  arrange(vertebral_number) %>%
  select(-vertebral_number) %>%
  group_by(level, side, object) %>%
  mutate(count = row_number()) %>%
  ungroup() %>%
  mutate(level_side_object = if_else(object %in% c("pelvic_screw"), str_to_lower(paste(side, level, object, count, sep = "_")), str_to_lower(paste(side, level, object, sep = "_")))) 

all_screws_long_df
all_screws_side_wide_df <- all_screws_long_df %>%
  select(level, side, object, count) %>%
  pivot_wider(names_from = side, values_from = object) %>%
  unnest() %>%
  mutate(left_object = paste("left", left, sep = "_")) %>%
  mutate(right_object = paste("right", right, sep = "_")) %>%
  select(-left, -right)


all_screws_side_wide_df %>%
  mutate(laterality = "bilateral") %>%
  mutate(shiny_input = pmap(list(
                                  ..1 = level_object,
                                  ..2 = right_object), 
         .f = ~ fluidRow(
           column(4, 
                             ..1), 
                      column(2, 
                             ..2), 
                      column(2, 
                             ..3), 
                      column(2, 
                             ..4), 
                      column(2, 
                             ..5)))
  )

  mutate(diameter_input = map(.x = level_side_object, .f = ~numericInput(inputId = paste0(.x, "_diameter"),
                                                                      label = NULL, 
                                                                      value = "",
                                                                      width = '75%'))) 


  all_implants_constructed_df
```



```{r}
screw_shiny_input_options_long_df <- all_implants_constructed_df %>%
  filter(vertebral_number < 23.9) %>%
  union_all(l6_all_implants_constructed_df) %>%
  select(level, vertebral_number, side, object) %>%
  filter(str_detect(object, "screw")) %>%
  filter(side == "left" | side == "right") %>%
  arrange(vertebral_number) %>%
  select(-vertebral_number) %>%
  group_by(level, side, object) %>%
  mutate(count = row_number()) %>%
  ungroup() %>%
  mutate(level_side_object = if_else(object %in% c("pelvic_screw"), str_to_lower(paste(side, level, object, count, sep = "_")), str_to_lower(paste(side, level, object, sep = "_")))) %>%
    mutate(diameter_input = map(.x = level_side_object, .f = ~numericInput(inputId = paste0(.x, "_diameter"),
                                                                      label = NULL, 
                                                                      value = "",
                                                                      width = '75%'))) %>%
    mutate(length_input = map(.x = level_side_object, .f = ~numericInput(inputId = paste0(.x, "_length"),
                                                                      label = NULL, 
                                                                      value = "",
                                                                      width = '75%'))) %>%
  mutate(type_input = map(.x = level_side_object,
                          .f = ~ radioGroupButtons( #"option2",  
                            inputId = .x,
                            label = NULL, 
                            choices = c("M", "U", "P", "Red", "Offset"),
                            selected = "P",
                            checkIcon = list(yes = icon("wrench")),
                            size = "xs", direction = "horizontal",
                            justified = TRUE,
                            width = "95%"
                          )
  )) %>%
  mutate(level_object = str_to_title(string = str_replace_all(paste(level, object, sep = " "), "_", " "))) %>%
  select(level, side, level_object, level_side_object, contains("input"))

screw_shiny_input_options_long_df



```


```{r}
left_screw_shiny_input_options_long_df <- screw_shiny_input_options_long_df %>%
  filter(side == "left") %>%
  select(level, level_object, left_object = level_side_object, left_diameter_input = diameter_input, left_length_input = length_input, left_type_input = type_input)


right_screw_shiny_input_options_long_df <- screw_shiny_input_options_long_df %>%
  filter(side == "right") %>%
  select(level, level_object, right_object = level_side_object, right_diameter_input = diameter_input, right_length_input = length_input, right_type_input = type_input)


screw_shiny_inputs_wide_df <- left_screw_shiny_input_options_long_df %>%
  full_join(right_screw_shiny_input_options_long_df) %>%
  mutate(implant_id = row_number()) %>%
  select(implant_id, everything()) %>%
  mutate(bilateral_input = pmap(list(
                                  ..1 = level_object,
                                  ..2 = left_diameter_input, 
                                ..3 = left_length_input, 
                                ..4 = right_diameter_input,
                                ..5 = right_length_input), 
         .f = ~ fluidRow(
           column(4, 
                             ..1), 
                      column(2, 
                             ..2), 
                      column(2, 
                             ..3), 
                      column(2, 
                             ..4), 
                      column(2, 
                             ..5)))
  ) %>% 
    mutate(left_only_input = pmap(list(
                                  ..1 = level_object,
                                  ..2 = left_diameter_input, 
                                ..3 = left_length_input),
         .f = ~ fluidRow(
           column(4, 
                             ..1), 
                      column(2, 
                             ..2), 
                      column(2, 
                             ..3), 
                      column(2, 
                             " "), 
                      column(2, 
                             " ")))
  ) %>% 
    mutate(right_only_input = pmap(list(
                                  ..1 = level_object,
                                  ..2 = right_diameter_input, 
                                ..3 = right_length_input), 
         .f = ~ fluidRow(
           column(4, 
                             ..1), 
                      column(2, 
                             " "), 
                      column(2, 
                             " "), 
                      column(2, 
                             ..2), 
                      column(2, 
                             ..3)))
  ) %>%
    mutate(bilateral_input = pmap(list(
                                  ..1 = level_object,
                                  ..2 = left_diameter_input, 
                                ..3 = left_length_input, 
                                ..4 = right_diameter_input,
                                ..5 = right_length_input), 
         .f = ~ fluidRow(
           column(4, 
                             ..1), 
                      column(2, 
                             ..2), 
                      column(2, 
                             ..3), 
                      column(2, 
                             ..4), 
                      column(2, 
                             ..5)))
  ) %>% 
    mutate(left_only_input = pmap(list(
                                  ..1 = level_object,
                                  ..2 = left_diameter_input, 
                                ..3 = left_length_input),
         .f = ~ fluidRow(
           column(4, 
                             ..1), 
                      column(2, 
                             ..2), 
                      column(2, 
                             ..3), 
                      column(2, 
                             " "), 
                      column(2, 
                             " ")))
  ) %>% 
    mutate(right_only_input = pmap(list(
                                  ..1 = level_object,
                                  ..2 = right_diameter_input, 
                                ..3 = right_length_input), 
         .f = ~ fluidRow(
           column(4, 
                             ..1), 
                      column(2, 
                             " "), 
                      column(2, 
                             " "), 
                      column(2, 
                             ..2), 
                      column(2, 
                             ..3)))
  ) %>%
  select(implant_id, level, level_object, left_object, right_object, bilateral_input, left_only_input, right_only_input)

screw_shiny_inputs_wide_df


screw_shiny_inputs_laterality_long_df <- screw_shiny_inputs_wide_df %>%
  select(implant_id, level_object, bilateral_input, left_only_input, right_only_input) %>%
  pivot_longer(cols = c(bilateral_input, left_only_input, right_only_input), names_to = "laterality", values_to = "shiny_input") %>%
  mutate(level_object_laterality = paste(level_object, laterality)) %>%
  select(implant_id, level_object, level_object_laterality,laterality, shiny_input)
  

screw_shiny_inputs_laterality_long_df

```



```{r}
test_vector <- c("left_c3_pedicle_screw", "left_c4_pedicle_screw", "left_c5_pedicle_screw", "right_c5_pedicle_screw")

  test_wide_df <- screw_shiny_inputs_wide_df %>%
    select(implant_id, left_object, right_object) %>%
    right_join(tibble(left_object = test_vector)) %>%
    filter(str_detect(left_object, "left")) %>%
    select(implant_id, left_object) %>%
    full_join(screw_shiny_inputs_wide_df %>%
                select(implant_id, right_object, right_object) %>%
                right_join(tibble(right_object = test_vector)) %>%
                filter(str_detect(right_object, "right")) %>%
                select(implant_id, right_object)) %>%
    replace_na(list(left_object = "xxx", right_object = "xxx")) %>%
    mutate(laterality = case_when(
      left_object != "xxx" & right_object != "xxx" ~ "bilateral_input", 
      left_object == "xxx" & right_object != "xxx" ~ "right_only_input",
      left_object != "xxx" & right_object == "xxx" ~ "left_only_input")) %>%
  select(implant_id, laterality)
  
  
  full_selected_screws_with_laterality_instruction_df <-  test_wide_df %>%
    left_join(screw_shiny_inputs_laterality_long_df)
  
  testfull_selected_screws_with_laterality_instruction_df
  
  
```



```{r}
jh_generate_screws_with_laterality_instruction_df_function <- function(screws_selected_vector){

  if(length(screws_selected_vector)>0){

  selected_screws_wide_df <- screw_shiny_inputs_wide_df %>%
    select(implant_id, left_object, right_object) %>%
    right_join(tibble(left_object = screws_selected_vector)) %>%
    filter(str_detect(left_object, "left")) %>%
    select(implant_id, left_object) %>%
    full_join(screw_shiny_inputs_wide_df %>%
                select(implant_id, right_object, right_object) %>%
                right_join(tibble(right_object = screws_selected_vector)) %>%
                filter(str_detect(right_object, "right")) %>%
                select(implant_id, right_object)) %>%
    replace_na(list(left_object = "xxx", right_object = "xxx")) %>%
    mutate(laterality = case_when(
      left_object != "xxx" & right_object != "xxx" ~ "bilateral_input", 
      left_object == "xxx" & right_object != "xxx" ~ "right_only_input",
      left_object != "xxx" & right_object == "xxx" ~ "left_only_input")) %>%
  select(implant_id, laterality)
  
  
  full_selected_screws_with_laterality_instruction_df <-  selected_screws_wide_df %>%
    left_join(screw_shiny_inputs_laterality_long_df) %>%
    select(-shiny_input)
  
  }else{
   full_selected_screws_with_laterality_instruction_df <-  screw_shiny_inputs_laterality_long_df %>%
     filter(implant_id == 9999)%>%
    select(-shiny_input)
  }

  return(full_selected_screws_with_laterality_instruction_df)

}

jh_generate_screws_with_laterality_instruction_df_function(screws_selected_vector = append(vector(), vector()))

jh_generate_screws_with_laterality_instruction_df_function(screws_selected_vector = c("left_c3_pedicle_screw"))

screw_shiny_inputs_laterality_long_df
```


```{r}

ui <- shinyUI(basicPage(
  
  box(width = 12,
      column(6, 
             pickerInput(inputId = "left_screw_options", 
                         label = "Select Left Screws", 
                         choices = screw_shiny_inputs_wide_df$left_object,
                         multiple = TRUE)
      ),
      column(6, 
             pickerInput(inputId = "right_screw_options", 
                         label = "Select Right Screws", 
                         choices = screw_shiny_inputs_wide_df$right_object,
                         multiple = TRUE)
             ),
      box(width = 12,  
          switchInput(inputId = "test", label = "Switch", value = FALSE),
             conditionalPanel(condition = "input.test == true",
                              checkboxGroupInput(inputId = "screw_options_for_verification",
                                                 label = "screws selected for verification:", 
                                                 choices = append(screw_shiny_inputs_wide_df$left_object, screw_shiny_inputs_wide_df$right_object)),
                              checkboxGroupInput(inputId = "screw_level_laterality", 
                                                 label = "Screw Levels:", 
                                                 choices = screw_shiny_inputs_wide_df$level_object)
             )
          ),
      hr(),
      box(width = 12,
          title = "Screw Size Inputs",
          fluidRow(
           column(4, 
                             "Implant"), 
                      column(2, 
                             "Left Diameter"), 
                      column(2, 
                             "Left Length"), 
                      column(2, 
                             "Right Diameter"), 
                      column(2, 
                             "Right Length")),
          map(.x = c(1:nrow(screw_shiny_inputs_wide_df)),
              .f = ~ fluidRow(
                column(12,
                       conditionalPanel(condition = glue("input.screw_level_laterality.indexOf('{screw_shiny_inputs_laterality_long_df$level_object_laterality[.x]}') >-1"),
                        screw_shiny_inputs_laterality_long_df$shiny_input[.x]
                       )
                )
              )
          )
      )
  ), 
  hr(),
  box(width = 12, 
      tableOutput(outputId = "screw_details_redcap_df_sidetab")
      )

))

################################################ SERVER ################################################ 
################################################ SERVER ################################################ 
################################################ SERVER ################################################ 

server <- function(input, output, session) {
  
  ####################### update levels and screws selected inputs
  observeEvent(list(input$left_screw_options, input$right_screw_options), {
     screw_options_selected <- append(input$left_screw_options, input$right_screw_options)
    
    if(length(screw_options_selected)>0){
         updateCheckboxGroupInput(session = session, 
                      inputId = "screw_options_for_verification",
                      choices = screw_options_selected,
                      selected = screw_options_selected) 
    }
  })
  
  observeEvent(screws_selected_full_laterality_df_reactive(), {
         updateCheckboxGroupInput(session = session, 
                      inputId = "screw_level_laterality", 
                      choices = screws_selected_full_laterality_df_reactive()$level_object_laterality,
                      selected = screws_selected_full_laterality_df_reactive()$level_object_laterality) 
  })
  
    ####################### Generate reactive DF
  
  screws_selected_full_laterality_df_reactive <- reactive({
    
    jh_generate_screws_with_laterality_instruction_df_function(screws_selected_vector = append(input$left_screw_options, input$right_screw_options))

  })
  
  
  output$screw_details_redcap_df_sidetab <- renderTable({
    
    screws_selected_full_laterality_df_reactive() %>%
      as_tibble()
    
  })
  
  
  
}

# rm(ui, server)

shinyApp(ui = ui, server = server)
```

