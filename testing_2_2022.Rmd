---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
packageList <- c("shiny", "shinyWidgets", "sf", "tidyverse", "shinyBS", "cowplot", "magick", "ggpattern", "glue", "rlist",
                 "janitor", "lubridate", "redcapAPI", "ggpmisc", "rclipboard", "nngeo", "shinydashboard")
for(package in packageList){
    if(!require(package,character.only = TRUE)){
        install.packages(package);require(package,character.only = TRUE);}
}

# install.packages("profvis")
# library(profvis)

source("short_shiny_functions.R", local = TRUE)
source("modal_functions.R", local = TRUE)
source("make_geoms_functions.R", local = TRUE)
source("build_spine_objects_functions.R", local = TRUE)
source("load_coordinates_build_objects.R", local = TRUE)
source("anterior_posterior_operative_note_generator_functions.R", local = TRUE)
source("load_coordinates_build_objects_6_lumbar.R", local = TRUE)
source("screw_size_type_inputs.R", local = TRUE)
source("load_icd_codes.R", local = TRUE)
source("no_implants_added_op_note.R", local = TRUE)

# (levels_numbered_df %>%
#   filter(between(vertebral_number, 0.1, 25.1)) %>%
#   filter(str_detect(level, "-", negate = TRUE)))$level
# , level != "Iliac", level != "S2AI")

# profvis({
#   runApp()
# })
```


```{r}
redcap_token <- paste0("2A930AE845C92CBF95467E59", "ADBA0D20")
    
rcon_test <- redcapConnection(url = 'https://redcap.uthscsa.edu/REDCap/api/', token = redcap_token)
    
        all_patient_ids_df <- exportRecords(rcon = rcon_test, fields = c("record_id", "last_name", "first_name", "date_of_birth"), events = "enrollment_arm_1") %>%
                   type.convert() %>%
                   select(record_id, last_name, first_name, date_of_birth) %>%
                   mutate(last_name = str_to_lower(last_name),
                          first_name = str_to_lower(first_name))
        
        all_patient_ids_df
                 
                 if(nrow(all_patient_ids_df)>0){
                   joined_df <- tibble(last_name = "haupt", first_name = "rachel", date_of_birth = "1974-07-16") %>%
                     select(last_name, first_name, date_of_birth) %>%
                     mutate(last_name = str_to_lower(last_name), 
                            first_name = str_to_lower(first_name)) %>%
                     left_join(all_patient_ids_df)
                   
                   match_found <- if_else(!is.na(joined_df$record_id[[1]]), TRUE, FALSE)
                   
                   if(match_found == TRUE){
                     record_number <- joined_df$record_id[[1]]
                     
                     patient_df <- exportRecords(rcon = rcon_test, records = record_number, fields = append(c("record_id", "dos_surg_repeating", "approach_repeating", "side", "object"), str_to_lower(str_replace_all(levels_vector, pattern = "-", replacement = "_")))) %>%                    as_tibble()  %>%
                       filter(redcap_repeat_instrument == "procedures_by_level_repeating")  %>%
                       type.convert() %>%
                       select(record_id, dos_surg_repeating, approach_repeating, side, str_replace_all(string = str_to_lower(levels_numbered_df$level), pattern = "-", replacement = "_")) %>%
                       pivot_longer(cols = str_replace_all(string = str_to_lower(levels_numbered_df$level), pattern = "-", replacement = "_"), names_to = "level", values_to = "object") %>%
                       filter(!is.na(object)) %>%
                       rename(approach = approach_repeating) %>%
                       mutate(level = str_to_title(str_replace_all(string = level, pattern = "_", replacement = "-"))) %>%
                       rename(date_of_surgery = dos_surg_repeating)
                     
                     match_found <- match_found
                     
                   }
                 }
        
        match_found
        
        patient_df
        
all_implants_constructed_df %>%
  filter(level == "S1", object == "pedicle_screw", side == "left")

test<- jh_generate_df_for_screening_screw_inputs_function(all_implants_constructed_df %>%
  filter(level == "S1", object == "pedicle_screw", side == "left"))

all_screw_size_type_inputs_df
```


```{r}
test

```


```{r}

ui <- shinyUI(basicPage(
  # dateInput(inputId = "input_date", label = "Date:", value = ""),
  box(checkboxGroupInput(inputId = "level_object_for_screw_details",
                                                                  label = "Screw Levels:",
                                                                  choices = test$level_object_label,
                                                                  selected = test$level_object_label),
                                               checkboxGroupInput(inputId = "left_level_object_for_screw_details",
                                                                  label = "Screw Levels:",
                                                                  choices = test$left_object,
                                                                  selected = test$left_object),
                                               checkboxGroupInput(inputId = "right_level_object_for_screw_details",
                                                                  label = "Screw Levels:",
                                                                  choices = test$right_object,
                                                                  selected = test$right_object)),
  box(map(.x = c(1:length(all_screw_size_type_inputs_df$level_object_label)),
          .f = ~
            conditionalPanel(condition = glue("input.level_object_for_screw_details.indexOf('{all_screw_size_type_inputs_df$level_object_label[[.x]]}') >-1"),
                             fluidRow(
                               column(4,
                                      all_screw_size_type_inputs_df$level_object_label[[.x]]
                               ),
                               column(2,
                                      conditionalPanel(condition = glue("input.left_level_object_for_screw_details.indexOf('{all_screw_size_type_inputs_df$left_object[[.x]]}') >-1"),
                                                       all_screw_size_type_inputs_df$left_diameter_input[[.x]]
                                      )
                               ),
                               column(2,
                                      conditionalPanel(condition = glue("input.left_level_object_for_screw_details.indexOf('{all_screw_size_type_inputs_df$left_object[[.x]]}') >-1"),
                                                       all_screw_size_type_inputs_df$left_length_input[[.x]]
                                      )
                               ),
                               column(2,
                                      conditionalPanel(condition = glue("input.right_level_object_for_screw_details.indexOf('{all_screw_size_type_inputs_df$right_object[[.x]]}') >-1"),
                                                       all_screw_size_type_inputs_df$right_diameter_input[[.x]]
                                      )
                               ),
                               column(2,
                                      conditionalPanel(condition = glue("input.right_level_object_for_screw_details.indexOf('{all_screw_size_type_inputs_df$right_object[[.x]]}') >-1"),
                                                       all_screw_size_type_inputs_df$right_length_input[[.x]]
                                      )
                               )
                             )
            )
  ))
))

server <- function(input, output) {
  # output$date_text_output <- renderText({
  # })
}

shinyApp(ui = ui, server = server)

```

```{r}
jh_add_codes_to_diagnosis_function(diagnosis_vector = c("low back pain"))

addition_surgical_details_modal_box_function(primary_surgeon_first_name_input = "Jeff", preoperative_diagnosis = "low back pain", postoperative_diagnosis = "test", indications = "indications test")


addition_surgical_details_modal_box_function()

glue("{165.34*83} for7yr vs {220.90*59} ")

# 
# df <- rsconnect::showMetrics(metricNames =  "docker_container_mem", 
#                              appName = "spine_templating_logging",
#                              # c("usage_in_usermode"),
#                              server="shinyapps.io", account = "hills-apps")


df
```
```{r}
source("short_shiny_functions.R", local = TRUE)
source("load_icd_codes.R", local = TRUE)
source("modal_functions.R", local = TRUE)
source("make_geoms_functions.R", local = TRUE)
source("build_spine_objects_functions.R", local = TRUE)
source("load_coordinates_build_objects.R", local = TRUE)
source("anterior_posterior_operative_note_generator_functions.R", local = TRUE)
source("load_coordinates_build_objects_6_lumbar.R", local = TRUE)
source("screw_size_type_inputs.R", local = TRUE)
source("load_icd_codes.R", local = TRUE)
source("no_implants_added_op_note.R", local = TRUE)

all_implants_constructed_df

l6_open_canal_df %>%
  remove_empty()


implant_starts_df %>%
      filter(object == "corpectomy") %>%
      select(level, x, y) %>%
      distinct() 

implant_starts_df %>%
  tabyl(object)

test_list_df <- list()

test_list_df$test_anterior_plate_df <- implant_starts_df %>%
  filter(object == "anterior_plate")

test_anterior_plate_df

test_list_df$corpectomy_df  <- implant_starts_df %>%
  filter(object == "corpectomy ")

test_list_df$pedicle_screw_df  <- implant_starts_df %>%
  filter(object == "pedicle_screw")

test_list_df$diskectomy_fusion_df  <- implant_starts_df %>%
  filter(object == "corpectomy ")

test_list_df
enframe(test_list_df) %>%
  unnest()

test_list_df[[1]] %>%
  union_all(test_list_df[[2]])
union_all(test_list_df[2:length(test_list_df)])

test_list_df$pedicle_screw_df

test_objects_df <- test_list_df$pedicle_screw_df %>%
  filter(level %in% c("L4", "L5")) %>%
  union_all(implant_starts_df %>% filter(object == "laminectomy", level %in% c("L4", "L5")))

construct_objects_live_function(all_procedures_selected_df = test_objects_df)

```


```{r}
implant_starts_df

all_implants_constructed_df

construct_objects_live_function <- function(all_procedures_selected_df){
  
  assembled_df <- implant_starts_df %>%
    filter(level == "xx")
  
  if(nrow(all_procedures_selected_df) > 0){
    
    if(any(all_procedures_selected_df$category == "implant")){
      assembled_df <- assembled_df %>%
        union_all(all_procedures_selected_df %>%
                    filter(category == "implant") %>%
                    mutate(sublaminar_band_length = length) %>%
                    mutate(length_for_tether = length) %>%
                    mutate(object_constructed = pmap(.l =  list(..1 = object, 
                                                                ..2 = x, 
                                                                ..3 = y, 
                                                                ..4 = angle,
                                                                ..5 = length, 
                                                                ..6 = width,
                                                                ..7 = sublaminar_band_length,
                                                                ..8 = length_for_tether, 
                                                                ..9 = superior_y, 
                                                                ..10 = inferior_y), .f = ~ screw_hook_implant_function(implant_type = ..1, 
                                                                                                                       start_x = ..2,
                                                                                                                       y = ..3,
                                                                                                                       angle = ..4,
                                                                                                                       screw_length_mod = ..5,
                                                                                                                       screw_width_mod = ..6, 
                                                                                                                       sublaminar_band_length = ..7, 
                                                                                                                       length_for_tether = ..8, 
                                                                                                                       y_superior = ..9, 
                                                                                                                       y_inferior = ..10))))
    }
    
    if(any(all_procedures_selected_df$category == "osteotomy")){
      #############-----------------------   Build Osteotomies  ----------------------###############

      assembled_df <- assembled_df %>%
        union_all(all_procedures_selected_df %>%
                    filter(category == "osteotomy") %>%
                    # remove_empty() %>%
                    mutate(object_constructed = pmap(list(..1 = level, 
                                                          ..2 = object,
                                                          ..3 = left_x,
                                                          ..4 = superior_y,
                                                          ..5 = right_x,
                                                          ..6 = inferior_y,
                                                          ..7 = superior_vert_lateral_pars_x, 
                                                          ..8 = superior_vert_inferior_pedicle_y,
                                                          ..9 = superior_lamina_y,
                                                          ..10 = lateral_tp_x, 
                                                          ..11 = inferior_lamina_y,
                                                          ..12 = lateral_pars_x,
                                                          ..13 = inferior_pedicle_y,
                                                          ..14 = superior_tp_y, 
                                                          ..15 = inferior_facet_lateral_border_x,
                                                          ..16 = inferior_facet_medial_border_x,
                                                          ..17 = inferior_facet_superior_border_y,
                                                          ..18 = inferior_facet_inferior_border_y,
                                                          ..19 = x), .f = ~build_osteotomy_function(level = ..1,
                                                                                                    x_click = ..19,
                                                                                                    osteotomy_grade = ..2,
                                                                                                    left_x = ..3,
                                                                                                    superior_y = ..4,
                                                                                                    right_x = ..5, 
                                                                                                    inferior_y = ..6,
                                                                                                    superior_vert_lateral_pars_x = ..7, 
                                                                                                    superior_vert_inferior_pedicle_y = ..8, 
                                                                                                    superior_lamina_y = ..9,
                                                                                                    lateral_tp_x = ..10, 
                                                                                                    inferior_lamina_y = ..11, 
                                                                                                    lateral_pars_x = ..12, 
                                                                                                    inferior_pedicle_y = ..13, 
                                                                                                    superior_tp_y = ..14,
                                                                                                    inferior_facet_lateral_border_x = ..15,
                                                                                                    inferior_facet_medial_border_x = ..16,
                                                                                                    inferior_facet_superior_border_y = ..17, 
                                                                                                    inferior_facet_inferior_border_y = ..18))))
    }
    
    posterior_df <- all_procedures_selected_df %>%
      filter(approach == "posterior")
    
    #############-----------------------   Build Decompressions  ----------------------###############
    if(any(posterior_df$category == "decompression" | posterior_df$category == "tumor")){
      assembled_df <- assembled_df %>%
        union_all(posterior_df %>%
                    filter(category == "decompression" | category == "tumor") %>%
                    mutate(object_constructed = pmap(list(..1 = left_x,
                                                          ..2 = superior_y,
                                                          ..3 = right_x,
                                                          ..4 = inferior_y,
                                                          ..5 = width, 
                                                          ..6 = object,
                                                          ..7 = lateral_pars_x,
                                                          ..8 = superior_tp_y,
                                                          ..9 = side, 
                                                          ..10 = inferior_pedicle_y,
                                                          ..11 = inferior_facet_superior_border_y), 
                                                     .f = ~ build_decompression_function(left_x = ..1,
                                                                                         superior_y = ..2,
                                                                                         right_x = ..3, 
                                                                                         inferior_y = ..4, 
                                                                                         top_width = ..5, 
                                                                                         object = ..6, 
                                                                                         x_lateral_pars = ..7, 
                                                                                         y_inferior_tp = ..8,
                                                                                         side = ..9, 
                                                                                         inferior_pedicle_y = ..10,
                                                                                         inferior_facet_superior_border_y = ..11))))
      
    }
    
    if(any(posterior_df$category == "incision_drainage")){

      assembled_df <- assembled_df %>%
        union_all(all_procedures_selected_df %>%
                    filter(approach == "posterior") %>%
                    filter(category == "incision_drainage") %>%
                    mutate(object_constructed = pmap(list(..1 = left_x,
                                                          ..2 = superior_y,
                                                          ..3 = right_x,
                                                          ..4 = inferior_y,
                                                          ..5 = width, 
                                                          ..6 = object,
                                                          ..7 = lateral_pars_x,
                                                          ..8 = superior_tp_y,
                                                          ..9 = side, 
                                                          ..10 = inferior_pedicle_y,
                                                          ..11 = inferior_facet_superior_border_y), 
                                                     .f = ~ build_incision_drainage_function(left_x = ..1,
                                                                                             superior_y = ..2,
                                                                                             right_x = ..3, 
                                                                                             inferior_y = ..4, 
                                                                                             top_width = ..5, 
                                                                                             object = ..6, 
                                                                                             x_lateral_pars = ..7, 
                                                                                             y_inferior_tp = ..8,
                                                                                             side = ..9, 
                                                                                             inferior_pedicle_y = ..10,
                                                                                             inferior_facet_superior_border_y = ..11))))
    }
    
    #############-----------------------   Build Interbody Fusions  ----------------------###############
    if(any(posterior_df$category == "interbody")){

      assembled_df <- assembled_df %>%
        union_all(all_procedures_selected_df %>%
                    filter(category == "interbody") %>%
                    filter(approach == "posterior") %>%
                    replace_na(list(superior_endplate_y = 0, inferior_endplate_y = 0, inferior_facet_lateral_border_x = 0, inferior_facet_medial_border_x = 0, inferior_facet_superior_border_y = 0, inferior_facet_inferior_border_y = 0)) %>%
                    mutate(object_constructed = pmap(list(..1 = object,
                                                          ..2 = x,
                                                          ..3 = right_x,
                                                          ..4 = left_x,
                                                          ..5 = superior_endplate_y,
                                                          ..6 = inferior_endplate_y, 
                                                          ..7 = width, 
                                                          ..8 = inferior_facet_lateral_border_x,
                                                          ..9 = inferior_facet_medial_border_x, 
                                                          ..10 = inferior_facet_superior_border_y,
                                                          ..11 = inferior_facet_inferior_border_y), 
                                                     .f = ~ build_interbody_function(object = ..1, 
                                                                                     x_click = ..2, 
                                                                                     left_x = ..3, 
                                                                                     right_x = ..4,
                                                                                     y_superior_endplate = ..5,
                                                                                     y_inferior_endplate = ..6,
                                                                                     top_width = ..7,
                                                                                     inferior_facet_lateral_border_x = ..8, 
                                                                                     inferior_facet_medial_border_x = ..9,
                                                                                     inferior_facet_superior_border_y = ..10,
                                                                                     inferior_facet_inferior_border_y = ..11))))
    }
    
    
    #############-------#############-----------------------   ANTERIOR  ----------------------###############-------###############
    #############-------#############-----------------------   ANTERIOR  ----------------------###############-------###############
    #############-------#############-----------------------   ANTERIOR  ----------------------###############-------###############
    #############-------#############-----------------------   ANTERIOR  ----------------------###############-------###############
    #############-------#############-----------------------   ANTERIOR  ----------------------###############-------###############
    #############-------#############-----------------------   ANTERIOR  ----------------------###############-------###############
    anterior_df <- all_procedures_selected_df %>%
      filter(approach == "anterior") %>%
      remove_empty() 
    
    if(nrow(anterior_df) > 0){
      assembled_df <- assembled_df %>%
        union_all(anterior_df %>%
                    mutate(object_constructed = pmap(list(..1 = object,
                                                          ..2 = width,
                                                          ..3 = inferior_endplate_y,
                                                          ..4 = superior_endplate_y, 
                                                          ..5 = superior_endplate_inferior_body_y, 
                                                          ..6 = inferior_endplate_superior_body_y,
                                                          ..7 = y, 
                                                          ..8 = direction),
                                                     .f = ~ anterior_implant_function(object_type = ..1, 
                                                                                      body_width = ..2,
                                                                                      inferior_endplate_y = ..3,
                                                                                      superior_endplate_y = ..4,
                                                                                      superior_endplate_inferior_body_y = ..5, 
                                                                                      inferior_endplate_superior_body_y = ..6, y_click = ..7, direction = ..8))))
    }
    
    
    
    #############-------#############-----------------------   ASSEMBLE ALL  ----------------------###############-------###############
    #############-------#############-----------------------   ASSEMBLE ALL  ----------------------###############-------###############
    #############-------#############-----------------------   ASSEMBLE ALL  ----------------------###############-------###############
    #############-------#############-----------------------   ASSEMBLE ALL  ----------------------###############-------###############
    #############-------#############-----------------------   ASSEMBLE ALL  ----------------------###############-------###############
    #############-------#############-----------------------   ASSEMBLE ALL  ----------------------###############-------###############
    
    
    objects_constructed_df <- assembled_df%>%
      select(level, vertebral_number, everything())%>%
      select(-ends_with("_x"), -ends_with("_y"))

    return(objects_constructed_df)
    
  }
}


```



```{r}

revision_implants_df <- all_points_all_implants_constructed_df %>%
      filter(object == "pedicle_screw" | str_detect(object, "pelvic_screw") | object == "occipital_screw") %>%
      filter(approach == "posterior") %>%
      arrange(vertebral_number) %>%
      distinct() %>%
      group_by(level, object, side) %>%
      filter(y == max(y)) %>%
      ungroup() %>%
      select(-ends_with("_x"), -ends_with("_y"))


revision_implants_constructed_df <- implant_starts_df %>%
  filter(category == "implant") %>%
  filter(object == "pedicle_screw" | str_detect(object, "pelvic_screw") | object == "occipital_screw") %>%
  filter(approach == "posterior") %>%
  mutate(sublaminar_band_length = length) %>%
  mutate(length_for_tether = length) %>%
  mutate(object_constructed = pmap(.l =  list(..1 = object, 
                                              ..2 = x, 
                                              ..3 = y, 
                                              ..4 = angle,
                                              ..5 = length, 
                                              ..6 = width,
                                              ..7 = sublaminar_band_length,
                                              ..8 = length_for_tether, 
                                              ..9 = superior_y, 
                                              ..10 = inferior_y), .f = ~ screw_hook_implant_function(implant_type = ..1, 
                                                                                                           start_x = ..2,
                                                                                                           y = ..3,
                                                                                                           angle = ..4,
                                                                                                           screw_length_mod = ..5,
                                                                                                           screw_width_mod = ..6, 
                                                                                                           sublaminar_band_length = ..7, 
                                                                                                           length_for_tether = ..8, 
                                                                                                     y_superior = ..9, 
                                                                                                     y_inferior = ..10)))%>%
      arrange(vertebral_number) %>%
      distinct() %>%
      group_by(level, object, side) %>%
      filter(y == max(y)) %>%
      ungroup() %>%
      select(-ends_with("_x"), -ends_with("_y"))

revision_implants_constructed_df

```

```{r}

library(shiny)

all_screw_size_type_inputs_df_test <-  implant_starts_df %>%
  filter(vertebral_number < 23.9) %>%
  # union_all(l6_all_implants_constructed_df) %>%
  select(level, vertebral_number, side, object) %>%
  filter(str_detect(object, "screw")) %>%
  filter(side == "left" | side == "right") %>%
  arrange(vertebral_number) %>%
  select(-vertebral_number) %>%
  group_by(level, side, object) %>%
  mutate(count = row_number()) %>%
  ungroup() %>%
  mutate(level_object = str_to_lower(paste(level, object, sep = "_"))) %>%
  mutate(level_object_label = str_to_title(paste(str_replace_all(level_object, "_", " ")))) %>%
  mutate(level_object_label = str_replace_all(level_object_label, "S2ai", "S2AI")) %>%
  mutate(level_object_label = str_replace_all(level_object_label, "Occiput Occ", "Occ")) %>%
  select(-side) %>%
  distinct() %>%
  mutate(left_object = paste("left", level_object, sep = "_"))%>%
  mutate(right_object = paste("right", level_object, sep = "_")) %>%
  mutate(implant_row_id = row_number()) %>%
  select(implant_row_id, everything()) %>%
  select(implant_row_id, level_object_label, left_object, right_object) %>%
  mutate(left_diameter_input = map(.x = left_object, 
                                   .f = ~numericInput(inputId = paste0(.x, "_diameter"),
                                                      label = NULL, 
                                                      value = "",
                                                      width = '85%'))) %>%
  mutate(left_length_input = map(.x = left_object, 
                                 .f = ~numericInput(inputId = paste0(.x, "_length"),
                                                    label = NULL, 
                                                    value = "",
                                                    width = '85%'))) %>%
  mutate(right_diameter_input = map(.x = right_object, 
                                    .f = ~numericInput(inputId = paste0(.x, "_diameter"),
                                                       label = NULL, 
                                                       value = "",
                                                       width = '85%'))) %>%
  mutate(right_length_input = map(.x = right_object, 
                                  .f = ~numericInput(inputId = paste0(.x, "_length"),
                                                     label = NULL, 
                                                     value = "",
                                                     width = '85%'))) %>%
  mutate(left_type_input = map(.x = left_object, 
                               .f = ~radioGroupButtons( #"option2",  
                                 inputId = paste0(.x, "_type"),
                                 label = NULL, 
                                 choices = c("M", "U", "P", "Red", "Offset"),
                                 selected = "P",
                                 checkIcon = list(yes = icon("wrench")),
                                 size = "xs", direction = "horizontal",
                                 justified = TRUE,
                                 width = "95%"
                               ))) %>%
  mutate(right_type_input = map(.x = right_object, 
                                .f = ~radioGroupButtons( #"option2",  
                                  inputId = paste0(.x, "_type"),
                                  label = NULL, 
                                  choices = c("M", "U", "P", "Red", "Offset"),
                                  selected = "P",
                                  checkIcon = list(yes = icon("wrench")),
                                  size = "xs", direction = "horizontal",
                                  justified = TRUE,
                                  width = "95%"
                                ))) 

all_screw_size_type_inputs_df_test

```


